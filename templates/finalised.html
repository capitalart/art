{# templates/finalised.html #}
{# Gallery of all finalised artworks with edit and export actions. #}
{% extends "main.html" %}
{% block title %}Finalised Artworks{% endblock %}

{% block content %}
<div class="container">
    <div class="page-title-row">
      <img src="{{ url_for('static', filename='icons/svg/light/number-circle-four-light.svg') }}" class="hero-step-icon" alt="Step 4: Finalised" />
      <h1>Finalised Artworks</h1>
    </div>
    <p class="help-tip">Finalised artworks have been reviewed and are ready for publishing. You can lock them in for export or make final edits.</p>
    <div class="view-toggle">
      <button id="grid-view-btn" class="btn btn-sm btn-secondary">Grid View</button>
      <button id="list-view-btn" class="btn btn-sm btn-secondary">List View</button>
    </div>

    {% if not artworks %}
      <div class="empty-state" style="text-align: center; margin-top: 4rem;">
          <p>No artworks have been finalised yet.</p>
          <a href="{{ url_for('artwork.artworks') }}" class="btn btn-primary" style="max-width: 250px;">Go to Artwork Gallery</a>
      </div>
    {% else %}
      <div class="finalised-grid" data-view-key="finalisedView">
        {% for art in artworks %}
          <div class="final-card">
            <div class="card-thumb">
                {% set main_thumb_path = art.seo_folder ~ '/' ~ (art.thumb or '') %}
                {% if art.thumb %}
                    <a href="#" class="final-img-link" data-img="{{ url_for('artwork.finalised_image', filename=art.seo_folder ~ '/' ~ (art.main_image or '')) }}">
                        <img src="{{ url_for('artwork.finalised_image', filename=main_thumb_path) }}" class="card-img-top" alt="{{ art.title }}">
                    </a>
                {% else %}
                    <img src="{{ url_for('static', filename='img/no-image.svg') }}" class="card-img-top" alt="No image available">
                {% endif %}
            </div>
            
            <div class="card-content-wrapper">
                <div class="card-details">
                    <div class="card-title">{{ art.title }}</div>

                    {# NEW (2025-08-04): Full description, tags, and materials for verification #}
                    <div class="card-description-full" tabindex="0" aria-label="Full Artwork Description">
                      <p>{{ art.description }}</p>
                    </div>

                    <div class="card-pills-section">
                        <h5>Tags</h5>
                        <div class="pill-list">
                            {% for tag in art.tags %}<span class="pill-item">{{ tag }}</span>{% endfor %}
                        </div>
                        <h5>Materials</h5>
                        <div class="pill-list">
                            {% for mat in art.materials %}<span class="pill-item">{{ mat }}</span>{% endfor %}
                        </div>
                    </div>

                    <div class="card-meta">
                        <div class="meta-item">
                            <span class="meta-label">SKU</span>
                            <span class="meta-value">
                                {{ art.sku or 'N/A' }}
                                {% if art.sellbrite_status == 'Synced' %}
                                    <span class="status-badge synced">Synced</span>
                                {% elif art.sellbrite_status == 'Not Found' %}
                                    <span class="status-badge not-found">Not Synced</span>
                                {% else %}
                                    <span class="status-badge offline">{{ art.sellbrite_status }}</span>
                                {% endif %}
                            </span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Price</span>
                            <span class="meta-value">${{ "%.2f"|format(art.price|float) }}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Colours</span>
                            <span class="meta-value">{{ art.primary_colour }} / {{ art.secondary_colour }}</span>
                        </div>
                        <div class="meta-item-separator"></div>
                        <div class="meta-item">
                            <span class="meta-label">Category</span>
                            <span class="meta-value">{{ art.sellbrite_category }}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Condition</span>
                            <span class="meta-value">{{ art.sellbrite_condition }}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Quantity</span>
                            <span class="meta-value">{{ art.sellbrite_quantity }}</span>
                        </div>
                    </div>
                </div>

                {% if art.mockups %}
                    <div class="mini-mockup-grid">
                        {% for m in art.mockups %}
                            {# FIX (2025-08-04): Use the direct finalised_image route for mockup thumbs #}
                            {% set m_thumb_path = art.seo_folder ~ '/THUMBS/' ~ m.thumbnail %}
                            <img src="{{ url_for('artwork.finalised_image', filename=m_thumb_path) }}" alt="Mockup thumbnail for {{ art.title }}"/>
                        {% endfor %}
                    </div>
                {% endif %}

                <div class="final-actions">
                  <a href="{{ url_for('artwork.edit_listing', aspect=art.aspect, filename=art.seo_folder ~ '.jpg') }}" class="btn btn-secondary">Edit</a>
                  <form method="post" action="{{ url_for('artwork.lock_it_in', seo_folder=art.seo_folder) }}" style="display:inline;">
                    <button type="submit" class="btn btn-primary">Lock</button>
                  </form>
                  <form method="post" action="{{ url_for('artwork.delete_artwork', seo_folder=art.seo_folder) }}" onsubmit="return confirm('Delete this artwork permanently?');">
                    <button type="submit" class="btn btn-danger">Delete</button>
                  </form>
                </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    {# Modal for viewing full-size images #}
    <div id="final-modal-bg" class="modal-bg">
      <button id="final-modal-close" class="modal-close" aria-label="Close modal">&times;</button>
      <div class="modal-img"><img id="final-modal-img" src="" alt="Full size artwork image"/></div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/gallery.js') }}"></script>
{% endblock %}